# CNC Router

## Протокол обмена данными по WebSocket
Команды передаются в виде пакетов длиной 16 байт. Нулевой байт - идентификатор устройства или действия, первый, возможно и второй - необходимые операции, далее - дополнительные параметры.

* [Передача на контроллер управляющей программы GCode](#передача-на-контроллер-управляющей-программы-gcode)
* [Подготовка и запуск управляющей программы GCode](#подготовка-и-запуск-управляющей-программы-gcode)
* [Перемещение по оси](#перемещение-по-оси)
* [Текущие координаты каретки станка](#текущие-координаты-каретки-станка)
* [Перемещение каретки станка на указанные координаты](#перемещение-каретки-станка-на-указанные-координаты)
* [Поджиг дуги плазмы](#поджиг-дуги-плазмы)

## Передача на контроллер управляющей программы GCode
Программа на контроллер передаётся не в чистом виде как есть, а в двоичном формате порциями по 100 фреймов. 
`OBJ_NAME_CNC_GCODE = 0x50;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| `50` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |


Далее идут фреймы программы со следующей структурой. Нулевой байт = `OBJ_NAME_CNC_GCODE`, первый и второй - номер строки программы (`N = (NH<<8)+NL`), затем параметры фрейма в виде `буква` (1 байт), `значение` длиной 1 байт если является целочисленным в диапазоне `0x00`-`0xFF` или 4 байта если является числом с плавающей точкой типа Float (Big Endian). Если все параметры не умещаются в 15 байт, то последний байт `LB` с индексом `F` становится равным `01` и следующие параметры передаются в следующих 16 байтах.  
Например, команда `G02 X20.0 R5.0` может иметь следующий вид:

|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `NL` | `NH` | ` G` | ` V` | ` X` | `V0` | `V1` | `V2` | `V3` | ` R` | `V0` | `V1` | `V2` | `V3` | `LB` |
| `50` | `08` | `00` | `01` | `02` | `11` | `00` | `00` | `A0` | `41` | `1A` | `00` | `00` | `A0` | `40` | `00` |

Видно, что для параметра `X` значение `20.0` закодировано числом `0x41A00000`, а для параметра `R` значение `5.0` - числом `0x40A00000`.  
  
Номер строки имеет размер 2 байта, что означает максимальное количество строк исходного gcode 65535. Увеличение размера до 3 байт (до 16 млн. строк) возможно в следующих версиях.

### Ответ
Порция фреймов принята
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `50` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |


### Идентификаторы параметров
| Буква |   ID   |
| :---: | ------ |
|  `G`  | `0x01` |
|  `N`  | `0x02` |
|  `M`  | `0x03` |
|  `O`  | `0x04` |
|  `X`  | `0x11` |
|  `Y`  | `0x12` |
|  `Z`  | `0x13` |
|  `A`  | `0x14` |
|  `B`  | `0x15` |
|  `C`  | `0x16` |
|  `P`  | `0x17` |
|  `F`  | `0x18` |
|  `S`  | `0x19` |
|  `R`  | `0x1A` |
|  `D`  | `0x1B` |
|  `L`  | `0x1C` |
|  `I`  | `0x1D` |
|  `J`  | `0x1E` |
|  `K`  | `0x1F` |


## Подготовка и запуск управляющей программы GCode
`OBJ_NAME_CNC_GCODE_PREPARE = 0x51;`

### Подготовка к загрузке программы на контроллер
Выяснение готовности принять программу.  
`PREPARE_SIZE = 0x01;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `CMD`| `S0` | `S1` | `S2` | `S3` |      |      |      |      |      |      |      |      |      |      |
| `51` | `01` | `D0` | `04` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

В байтах 2-5 содержится требуемый размер программы в двоичном виде `uint32_t size = (S3<<24) + (S2<<16) + (S1<<8) + s0`, в байтах.  
Из примера выше `size = (0x04<<8) + 0xD0`, что равно 1232.

### Ответ
Контроллер готов принять программу
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `51` | `01` | `01` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

Контроллер не готов принять программу
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `51` | `01` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |


### Запуск программы на выполнение
`PREPARE_RUN = 0x02;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `CMD`|`TEST`|      |      |      |      |      |      |      |      |      |      |      |      |      |
| `51` | `02` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

```cpp
TEST = 0x00;            // выполнение программы (по-умолчанию)
TEST = 0x01;            // тестовый прогон по программе без включения рабочего органа
```

### Ответ
Программа запущена на выполнение
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `51` | `02` | `01` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

Программа не готова к выполнению
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `51` | `02` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |


## Перемещение по оси
`OBJ_NAME_AXE = 0x52;`

### Запуск перемещения
`CMD_RUN = 0x03;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `CMD`| `AXE`| `DIR`| `S0` | `S1` | `S2` | `S3` | `LIM`|      |      |      |      |      |      |      |
| `52` | `03` | `01` | `01` | `00` | `00` | `48` | `42` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

#### Идентификатор оси `AXE`
|   Ось   |   ID   |
| ------- | ------ |
| `AXE_X` | `0x01` |
| `AXE_Y` | `0x02` |
| `AXE_Z` | `0x03` |
| `AXE_A` | `0x04` |
| `AXE_B` | `0x05` |
| `AXE_C` | `0x06` |

#### Направление `DIR`
```cpp
AXE_DIRECTION_FORWARD = 0x01;     // в прямом направлении
AXE_DIRECTION_BACKWARD = 0x02;    // в обратном направлении
```

#### Скорость перемещения `SPEED`
Скорость представлена 4-х байтным числом (`S0`-`S3`) типа Float (Big Endian). Единица измерения: мм/сек.

#### Продолжить после предела `LIM`
```cpp
LIM = 0x01;     // продолжить движение при достижении предела программного или от датчика
LIM = 0x00;     // прекратить движение
```

### Ответ
*Отсутствует*

### Остановка перемещения
`CMD_STOP = 0x04;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `CMD`| `AXE`|      |      |      |      |      |      |      |      |      |      |      |      |      |
| `52` | `04` | `01` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

### Ответ
*Отсутствует*


## Текущие координаты каретки станка
Запрос на получение текущих координат отсутствует. Реализвция возможна. Контроллер сам инициирует передачу актуальных координат при их изменении.  
Формат данных от контроллера.  
`OBJ_NAME_COORDS = 0x53;`  
`CMD_READ = 0x01;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `CMD`| `X0` | `X1` | `X2` | `X3` | `Y0` | `Y1` | `Y2` | `Y3` | `Z0` | `Z1` | `Z2` | `Z3` |      |      |
| `53` | `01` | `00` | `00` | `34` | `42` | `00` | `00` | `9E` | `42` | `00` | `00` | `16` | `C3` | `00` | `00` |

Координаты `X`, `Y` и `Z` представлены 4-х байтными числами (`X0`-`X3`, `Y0`-`Y3`, `Z0`-`Z3` соответственно) типа Float (Big Endian). Единица измерения: мм.

## Перемещение каретки станка на указанные координаты
`OBJ_NAME_COORD_TARGET = 0x54;`  
`CMD_RUN = 0x03;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `CMD`| `X0` | `X1` | `X2` | `X3` | `Y0` | `Y1` | `Y2` | `Y3` | `Z0` | `Z1` | `Z2` | `Z3` |      |      |
| `54` | `03` | `00` | `00` | `34` | `42` | `00` | `00` | `9E` | `42` | `00` | `00` | `16` | `C3` | `00` | `00` |

Координаты `X`, `Y` и `Z` представлены 4-х байтными числами (`X0`-`X3`, `Y0`-`Y3`, `Z0`-`Z3` соответственно) типа Float (Big Endian). Единица измерения: мм.

### Ответ
*Отсутствует*


## Поджиг дуги плазмы
`OBJ_NAME_PLASMA_ARC = 0x55;`

### Поджиг дуги
`PLASMA_ARC_START = 0x01;`  
`CMD_RUN = 0x03;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `ARC`| `CMD`|      |      |      |      |      |      |      |      |      |      |      |      |      |
| `55` | `01` | `03` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

### Ответ
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `55` | `01` | `03` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

### Отключение дуги
`PLASMA_ARC_START = 0x01;`  
`CMD_STOP = 0x04;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `ARC`| `CMD`|      |      |      |      |      |      |      |      |      |      |      |      |      |
| `55` | `01` | `04` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

### Ответ
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `55` | `01` | `04` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |


### Флаг рабочего режима дуги
`PLASMA_ARC_STARTED = 0x02;`  
`CMD_READ = 0x01;`
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `ID` | `ARC`| `CMD`|      |      |      |      |      |      |      |      |      |      |      |      |      |
| `55` | `02` | `01` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

### Ответ
Дуга запущена
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `55` | `02` | `01` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

Дуга не запущена
|  0   |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  A   |  B   |  C   |  D   |  E   |  F   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| `55` | `02` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` | `00` |

## Напряжение дуги
`PLASMA_ARC_VOLTAGE = 0x03;`  
*Зарезервировано*


